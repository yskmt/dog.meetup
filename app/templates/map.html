<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<meta name="description" content="Dog.Meetup: Dog meetup app">
		<meta name="author" content="Yusuke Sakamoto">
		<link rel="icon" href="../../favicon.ico">

		<!-- send values to javascript -->
		<meta id="hour" data-name="{{ hour }}">
		<meta id="hour_24" data-name="{{ hour_24 }}">
		<meta id="kde_score_max" data-name="{{ kde_score_max }}">
		<meta id="tempfile" data-name="{{ tempfile }}">


		<link rel="stylesheet prefetch" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

		
		<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/boot<\!-- strap.min.css"> -\-> -->
		<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css"> -->
		
		<title>Dog.Meetup</title>

		<!-- <link href="../static/css/bootstrap.min.css" rel="stylesheet"> -->

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>

		
		<script src="{{ url_for('static', filename='js/set_objects.js') }}"></script>
		<link href="../static/css/starter-template.css"
			  rel="stylesheet">
		<!-- <link href="../static/css/style.css" -->
			  <!-- rel="stylesheet"> -->
		
	</head>

	<body>


      <!-- Fixed navbar -->
      <nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
          <div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="#">Dog.Meetup</a>
          </div>
		  
          <div id="navbar" class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#about">About</a></li>
              <li><a href="#contact">Contact</a></li>

			</ul>
			
			<ul class="nav navbar-nav navbar-right">
              <li><a href="../navbar-static-top/">Presentation</a></li>
              <li class="active"><a href="./">Github<span class="sr-only">(current)</span></a></li>
			</ul>
			
          </div><!--/.nav-collapse -->
		</div>
      </nav>


		<div id="map"></div>
	  
		<!-- render map -->
		<script>
		 google.load('visualization', '1.0', {'packages':['corechart']});

		 function getAMPM(time){
			 if (time==0){
				 return 12 + ' AM';
			 }
			 else if (time<=11){
				 return time + ' AM';
			 }
			 else if(time==12){
				 return time + ' PM';
			 }
			 else {
				 return (time%12) + ' PM';
			 }
		 }
		 
		 var map;
		 var myLatLng;  /* center of the search */
		 var heatmap;
		 var heatpoints = [];
		 var markers = [];
		 var top3_markers = [];
		 var ellipses = [];
		 var is_marker = 0; /* 0: heatmap, 1: markers, 2: cluster */
		 var info_window_cluster;
		 var hour = $('meta#hour').data()['name'];
		 var hour_24 = $('meta#hour_24').data()['name'];
		 var kde_score_max = $('meta#kde_score_max').data()['name'];
		 var tempfile = $('meta#tempfile').data()['name'];

		 function CenterControl(controlDiv, map) {

			 /* Set CSS for the control border. */
			 var controlUI = document.createElement('div');
			 controlUI.setAttribute("id", "toggleButton")
				 controlUI.style.backgroundColor = '#fff';
			 controlUI.style.border = '2px solid #fff';
			 controlUI.style.borderRadius = '3px';
			 controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
			 controlUI.style.cursor = 'pointer';
			 controlUI.style.marginBottom = '22px';
			 controlUI.style.textAlign = 'center';
			 controlUI.title = 'Click to recenter the map';
			 controlDiv.appendChild(controlUI);

			 /* Set CSS for the control interior. */
			 var controlText = document.createElement('div');
			 controlText.style.color = 'rgb(25,25,25)';
			 controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
			 controlText.style.fontSize = '16px';
			 controlText.style.lineHeight = '38px';
			 controlText.style.paddingLeft = '5px';
			 controlText.style.paddingRight = '5px';
			 controlText.innerHTML = 'Toggle Markers/Clusters/Heatmap';
			 controlUI.appendChild(controlText);

			 /* Setup the click event listeners: simply set the
				map to Chicago. */
			 controlUI.addEventListener('click', function() {
				 toggleVisualizations();
			 });
			 
		 }

		 jQuery(document).ready(function($){
			 var	main_color = '#0085a1',
					saturation_value= -20,
					brightness_value= 5;
			 var styles = [ 
				 {
					 elementType: "labels",
					 stylers: [
						 {saturation: saturation_value}
					 ]
				 },  
				 {
					 featureType: "poi",
					 elementType: "labels",
					 stylers: [
						 {visibility: "off"}
					 ]
				 },
				 {
					 featureType: 'road.highway',
					 elementType: 'labels',
					 stylers: [
						 {visibility: "off"}
					 ]
				 }, 
				 {
					 featureType: "road.local", 
					 elementType: "labels.icon", 
					 stylers: [
						 {visibility: "off"} 
					 ] 
				 },
				 {
					 featureType: "road.arterial", 
					 elementType: "labels.icon", 
					 stylers: [
						 {visibility: "off"}
					 ] 
				 },
				 {
					 featureType: "road",
					 elementType: "geometry.stroke",
					 stylers: [
						 {visibility: "off"}
					 ]
				 },
				 { 
					 featureType: "transit", 
					 elementType: "geometry.fill", 
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 }, 
				 {
					 featureType: "poi",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "poi.government",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "poi.sport_complex",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "poi.attraction",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "poi.business",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "transit",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "transit.station",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "landscape",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
					 
				 },
				 {
					 featureType: "road",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 },
				 {
					 featureType: "road.highway",
					 elementType: "geometry.fill",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 }, 
				 {
					 featureType: "water",
					 elementType: "geometry",
					 stylers: [
						 { hue: main_color },
						 { visibility: "on" }, 
						 { lightness: brightness_value }, 
						 { saturation: saturation_value }
					 ]
				 }
			 ];

			 /* 
				$('div#map').attr("width", $("div.container").width());
				$('div#map').attr("height", $("div.container").width()); */

			 myLatLng = {lat:{{ center[0] }},
						 lng:{{ center[1] }}};

			 /* Create an array of styles. */
			 /* http://googlemaps.github.io/js-samples/styledmaps/wizard/index.html */
			 /* var styles = [
				{ "featureType": "road",
				"elementType": "geometry.stroke",
				"stylers": [ { "invert_lightness": true },
				{ "visibility": "on" },
				{ "color": "#d88080" },
				{ "weight": 0.1 } ] } ]; */
			 var styledMap = new google.maps.StyledMapType(styles,
														   {name: "Styled Map"});
			 
			 map = new google.maps.Map(document.getElementById('map'), {
				 zoom: 13,
				 center: myLatLng,
				 scaleControl: true,
				 mapTypeControlOptions: {
					 mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
				 }

			 });

			 map.mapTypes.set('map_style', styledMap);
			 map.setMapTypeId('map_style');

			 /* Create the DIV to hold the control and call the
				CenterControl() constructor */
			 /* passing in this DIV. */
			 var centerControlDiv = document.createElement('div');
			 var centerControl = new CenterControl(centerControlDiv, map);

			 centerControlDiv.index = 1;
			 map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(centerControlDiv);
			 
			 /* Heatmap */
			 heatmap = new google.maps.visualization.HeatmapLayer({
				 data: getPoints(),
				 map: map,
				 radius: 0.0025,
				 dissipating: false,
				 maxIntensity: 20
			 });
			 
			 var dataset = {{ photos|tojson }};
			 var clusters = {{ cluster_shape|tojson }};
			 var num_labels = {{ num_labels }};
			 var max_label = {{ max_label }};
			 var top3 = {{ top3|tojson }};
			 
			 var colors20 = d3.scale.category20().range();

			 if (max_label > 20){
				 var pinColors = d3.scale.linear()
								   .domain(linspace(0, max_label, 20))
								   .range(colors20);
			 }
			 else{
				 var pinColors = d3.scale.linear()
								   .domain(linspace(0, max_label, 20))
								   .range(colors20.slice(0, max_label-1));
			 }
			 
			 var infowindow = new google.maps.InfoWindow();

			 /* plot individual markers/photos */
			 jQuery.each(dataset, function(i, d) {
				 
				 heatpoints.push({
				  	 location: new google.maps.LatLng(
				  		 parseFloat(d["latitude"]),
				  		 parseFloat(d["longitude"])),
				  	 weight: parseFloat(d["kde_score_2"])}
				 );

				 /* 
					heatpoints.push({
					location: new google.maps.LatLng(
					parseFloat(d["latitude"]),
					parseFloat(d["longitude"]))}
					); */

				 var pc = pinColors(parseFloat(d["label"]));
				 var latlng = {lat: parseFloat(d["latitude"]),
							   lng: parseFloat(d["longitude"])};
				 
				 var circle = new google.maps.Marker({
					 position: latlng,
					 icon: {
						 path: google.maps.SymbolPath.CIRCLE,
						 fillOpacity: 0.8,
						 fillColor: pc,
						 strokeOpacity: 1.0,
						 strokeColor: 'gray',
						 strokeWeight: 1.0, 
						 scale: 5
					 },
					 map: null
				 });

				 markers.push(circle);

				 var contentstring = "<p>" + d["description"] + "<\p>"
								   + "<p><div class=\"tags\">"
								   + d["tags"] + "</div><\p>"
								   + "<a href=\""+ d["url_m"] + "\">"
								   + "<img src=\""+ d["url_t"] + "\">"
								   + "</a>"
								   + "<p>" + d["datetaken"] + "</p>"
								   + "<p>" + d["label"] + "</p>";

				 circle.addListener('click', function() {
					 infowindow.setContent(contentstring);
					 infowindow.open(map, circle);						 						 
				 });
				 
			 });

			 var directionsService = new google.maps.DirectionsService;
			 var directionsDisplays = [];
			 var k=0;
			 /* 			 directionsDisplay.setMap(map); */

			 /* top 3 clusters */
			 jQuery.each(top3, function(i, d) {
				 
				 var pc = pinColors(parseFloat(d["label"])).slice(1);
				 var latlng = {lat: parseFloat(d["latitude"]),
							   lng: parseFloat(d["longitude"])};

				 var pinColor = pc;
				 var pinImage = 
				 new google.maps.MarkerImage(
					 "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
					 new google.maps.Size(21, 34),
					 new google.maps.Point(0,0),
					 new google.maps.Point(10, 34));

				 var circle = new google.maps.Marker({
					 position: latlng,
					 map: map,
					 title: 'top',
					 icon: pinImage,
					 zIndex: 1000000,
					 optimized: false
				 });
				 
				 top3_markers.push(circle);

				 var contentstring = "<p>" + d["kde_score_2"] + "</p>";

				 circle.addListener('click', function(event) {
					 
					 /* ajax request */
					 $.getJSON('/_add_numbers', {
						 lat: event.latLng.lat(),
						 lon: event.latLng.lng(),
						 lat_c: myLatLng.lat,
						 lon_c: myLatLng.lng,
						 kde_score_max: kde_score_max,
						 tempfile: tempfile
					 }, function(data) {

						 score = [];
						 $.each(data.result[0], function(i,d){
							 /* v: time of day, f: string */
							 if (+i == +hour_24){
								 score.push([{v: [(+i), 0, 0], f: i}, d, 'red', getAMPM(+i)]);
							 }
							 else{
								 score.push([{v: [(+i), 0, 0], f: i}, d, 'color: #76A7FA', getAMPM(+i)]);
							 }
						 });

						 var data = new google.visualization.DataTable();
						 data.addColumn('timeofday', 'Time of a Day');
						 data.addColumn('number', '');
						 data.addColumn({ type: 'string', role: 'style' });
						 data.addColumn({ type: 'string', role: 'tooltip' });
						 
						 data.addRows(score);
						 
						 var options = {
							 title: 'Dog Level Throughout a Day (out of 5)',
							 hAxis: {
								 title: 'Time of a Day',
								 format: 'h a',
								 viewWindow: {
									 min: [0, 0, 0],
									 max: [24, 0, 0]
								 },
								 ticks: [[0,0,0], [6,0,0], [12,0,0], [18,0,0], [24,0,0]]
							 },
							 vAxis: {
								 title: 'level',
								 minValue: 0,
								 maxValue: 5.5,
								 ticks: [0, 1, 2, 3, 4, 5]
							 },
							 legend: 'none'
						 };

						 var node        = document.createElement('div'),
							 info_window = new google.maps.InfoWindow(),
							 chart       = new google.visualization.ColumnChart(node);
						 
						 chart.draw(data, options);
						 
						 /* Replace the info window's content and position. */
						 info_window.setContent(node);
						 info_window.setPosition(event.latLng);
						 info_window.open(map);
					 });

				 }); /* addListner */

				 
				 directionsDisplays.push(
					 new google.maps.DirectionsRenderer({
						 polylineOptions: {
							 strokeColor: '#'+pc
						 },
						 preserveViewport: true
					 })
				 );

				 calculateAndDisplayRoute(directionsService, directionsDisplays[k],
										  myLatLng, latlng);
				 directionsDisplays[k].setMap(map);
				 k += 1;
			 });


			 /* heat map only			  */
			 map.addListener('click', function(event) {
				 if (is_marker != 0){
					 return false;
				 }
				 
				 /* ajax request */
				 $.getJSON('/_add_numbers', {
					 lat: event.latLng.lat(),
					 lon: event.latLng.lng(),
					 lat_c: myLatLng.lat,
					 lon_c: myLatLng.lng,
					 kde_score_max: kde_score_max,
					 tempfile: tempfile
				 }, function(data) {

					 score = [];
					 $.each(data.result[0], function(i,d){
						 /* v: time of day, f: string */
						 if (+i == +hour_24){
							 score.push([{v: [(+i), 0, 0], f: i}, d, 'red']);
						 }
						 else{
							 score.push([{v: [(+i), 0, 0], f: i}, d, 'color: #76A7FA']);
						 }
					 });

					 var data = new google.visualization.DataTable();
					 data.addColumn('timeofday', 'Time of a Day');
					 data.addColumn('number', '');
					 data.addColumn({ type: 'string', role: 'style' });
					 
					 data.addRows(score);
					 
					 var options = {
						 title: 'Dog Level Throughout a Day (out of 5)',
						 hAxis: {
							 title: 'Time of a Day',
							 format: 'h:mm a',
							 viewWindow: {
								 min: [0, 0, 0],
								 max: [24, 0, 0]
							 }
						 },
						 vAxis: {
							 title: 'level',
							 minValue: 0,
							 maxValue: 5.5,
							 ticks: [0, 1, 2, 3, 4, 5]
						 },
						 legend: 'none'
					 };

					 var node        = document.createElement('div'),
						 info_window = new google.maps.InfoWindow(),
						 chart       = new google.visualization.ColumnChart(node);
					 
					 chart.draw(data, options);
					 
					 /* Replace the info window's content and position. */
					 info_window.setContent(node);
					 info_window.setPosition(event.latLng);
					 info_window.open(map);
				 });

			 }); /* addListner */

			 /* calculate the minimum dlat and dlon for cluster radii */
			 var R = 6371.0;
			 var d_min_m = 0.5;

			 var tan = Math.tan(d_min_m/2/R);
			 var a_sq = tan/(1+tan);
			 
			 var dlat = 2*Math.asin(a_sq);
			 var dlon = 2*Math.asin(a_sq/Math.cos(myLatLng.lat));

			 dlat = dlat/2/Math.PI*180;
			 dlon = dlon/2/Math.PI*180;
			 
			 /* plot each clusters */
			 jQuery.each(clusters, function(i, d) {
				 var pc = pinColors(parseFloat(i));
				 
				 var radii_x = (+d['radii_x']<dlon ? dlon : +d['radii_x']);
				 var radii_y = (+d['radii_y']<dlat ? dlat : +d['radii_y']);

				 xys = get_ellipse_coords(radii_x, radii_y,
		  +d['lon_c'], +d['lat_c'], +d['orientation'], +d['num_pics'], 10);

				 xs = xys[0];
				 ys = xys[1];
				 den = xys[2];

				 ellipses.push(show_polygon(map, xs, ys,
											{num_pics: +d['num_pics'],
											 hour: hour},
											myLatLng,
											den, pc));
				 
			 });

			 var marker = new google.maps.Marker({
				 position: myLatLng,
				 map: map,
				 title: 'center'
			 });

			 /* heatmap and top3 markers are on in the beginning */
			 heatmap.setMap(map);
			 showTop3();

			 /* center on resize */
			 google.maps.event.addDomListener(window, 'load', initMap);
			 google.maps.event.addDomListener(window, "resize", function() {
				 google.maps.event.trigger(map, "resize");
				 myLatLng = {lat:{{ center[0] }},
							 lng:{{ center[1] }}};
				 map.setCenter(myLatLng); 
			 });

			 
			 // var map_options = {
			 //   	center: new google.maps.LatLng(latitude, longitude),
				 //   	zoom: map_zoom,
				 //   	panControl: false,
				 //   	zoomControl: true,
				 //   	mapTypeControl: false,
				 //   	streetViewControl: false,
				 //   	mapTypeId: google.maps.MapTypeId.ROADMAP,
				 //   	scrollwheel: false,
				 //   	styles: style,
				 // 	zoomControlOptions: {
			 // 		style: google.maps.ZoomControlStyle.SMALL,
				 // 		position: google.maps.ControlPosition.BOTTOM_CENTER
			 // 	}
			 // }
			 // var map = new google.maps.Map(document.getElementById('map'), map_options);			
			 // var marker = new google.maps.Marker({
			 //   	position: new google.maps.LatLng(latitude, longitude),
				 //     map: map,
				 //     visible: true,
				 //  	icon: marker_url,
				 // });
		 });

		 
		 function initMap() {
			 
		 }  /* initMap */

		 
		 function calculateAndDisplayRoute(directionsService, directionsDisplay,
		 originLatLng, destLatLng){
			 directionsService.route({
				 origin: originLatLng,
				 destination: destLatLng,
				 travelMode: google.maps.TravelMode.WALKING
			 }, function(response, status) {
				 if (status === google.maps.DirectionsStatus.OK) {
					 directionsDisplay.setDirections(response);
				 } else {
					 window.alert('Directions request failed due to ' + status);
				 }
			 });
			 directionsDisplay.setOptions( { suppressMarkers: true } );
		 }
		 
		 function getPoints() {
			 return heatpoints;
		 }
		 
		 function toggleVisualizations() {

			 /* 				 markers --> clusters */
			 if (is_marker==1){
				 clearMarkers();
				 showClusters();
				 is_marker=2;
			 }
			 /* heatmap --> markers */
			 else if (is_marker==0){
				 heatmap.setMap(null);
				 clearTop3();
				 showMarkers();
				 showTop3();
				 is_marker=1;
			 }
			 /* clusters --> heatmap */
			 else{
				 clearClusters();
				 heatmap.setMap(map);
				 showTop3();
				 is_marker = 0;
			 }

		 }

		 function clearMarkers() {
			 for (var i = 0; i < markers.length; i++) {
				 markers[i].setMap(null);
			 }
		 }

		 function showMarkers() {
			 for (var i = 0; i < markers.length; i++) {
				 markers[i].setMap(map);
			 }
		 }

		 function showTop3() {
			 for (var i = 0; i < top3_markers.length; i++) {
				 top3_markers[i].setMap(map);
			 }
		 }

		 function clearTop3() {
			 for (var i = 0; i < top3_markers.length; i++) {
				 top3_markers[i].setMap(null);
			 }
		 }


		 function clearClusters() {
			 for (var i = 0; i < ellipses.length; i++) {
				 ellipses[i].setMap(null);
			 }
		 }

		 function showClusters() {
			 for (var i = 0; i < ellipses.length; i++) {
				 ellipses[i].setMap(map);
			 }
		 }


		 /* scroll after map is loaded */
		 $("document").ready(function(){
			 document.getElementById('map').scrollIntoView();
		 });
		 
		</script>

		<!-- <script async defer -->
				<!-- src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7LvwvLJN0l04rFfHbIyUBsqi61vP6qWA&signed_in=true&libraries=visualization&callback=initMap"></script> -->

    
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7LvwvLJN0l04rFfHbIyUBsqi61vP6qWA&signed_in=true&libraries=visualization&extension=.js"></script>



<!-- <script src="http://maps.googleapis.com/maps/api/js?sensor=false&extension=.js"></script> -->

<!-- <script src="{{ url_for('static', filename='js/index.js') }}"></script> -->

		
		<!-- Bootstrap core JavaScript
			 ================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		

		<div class="chart"></div>
	</body>
</html>
